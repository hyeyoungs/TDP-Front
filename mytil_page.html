<!DOCTYPE html>
<html lang="en">
<head>
    <title>Title | TIL.D.P</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap tags -->
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
          integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
          crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet"
          id="bootstrap-css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- total js -->
    <script src="back.js" rel="script"></script>

    <!-- Toast Bulma -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="./back.css">

    <script>
        $(document).ready(function () {
            list_user_til();
            read_user();
        });

        $.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
            login_check(options, originalOptions, jqXHR);
        });

        function list_user_til() {
            $.ajax({
                type: "GET",
                url: `${domainURL}/til/user`,
                data: {},
                success: function (response) {
                    let my_til = response;
                    for (let i = 0; i < my_til.length; i++) {
                        make_list_my_til(my_til[i]);
                    }
                }
            });
        }

        function make_list_my_til(til){
            let view_str = '';
            if (til['tilView'] === true) {
                view_str = '공개';
            } else if (til['tilView'] === false) {
                view_str = '비공개';
            } else {
                alert("공개 범위의 값이 잘못된 형식 입니다.");
            }
            let temp_html = `
                            <!--- Post-->
                            <div class="card gedf-card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="mr-2">
                                                <!-- Profile Image -->
                                                <img class="rounded-circle" width="45" src="${til['user']['picture_real']}" alt="">
                                            </div>
                                            <div class="ml-2">
                                                <div class="h5 m-0">@${til['user']['username']}</div>
                                                <div class="h7 text-muted user_nickname_append">${til['user']['nickname']}</div>
                                            </div>
                                        </div>
                                        <!-- Dropdown -->
                                        <div class="btn-group">
                                            <ul>
                                             <li><button class="dropdown-item" onclick = "get_til('${til['id']}')" data-toggle="modal" data-target="#exampleModal">수정</button></li>
                                             <li><a class="dropdown-item" onclick = "delete_til('${til['id']}')">삭제</a></li>
                                             <li><a class="dropdown-item" onclick = "update_view('${til['id']}')">${view_str}</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="text-muted h7 mb-2"> <i class="fa fa-clock-o"></i>${til['createdAt']}</div>
                                    <a class="card-link" href="#">
                                        <h5 class="card-title">${til['tilTitle']}</h5>
                                    </a>
                                    <p class="card-text">
                                        ${ til['tilContent']}
                                    </p>
                                </div>
                                <div class="card-footer">
                                    <a href="#" class="card-link"><i class="fa fa-gittip"></i> Like</a>
                                    <a href="#" class="card-link"><i class="fa fa-comment"></i> Comment</a>
                                    <a href="#" class="card-link"><i class="fa fa-mail-forward"></i> Share</a>
                                </div>
                            </div>
                            <!-- Post End -->`;
            $('#post-list').append(temp_html);
        }

        function get_til(idx){
            $.ajax({
                type: "GET",
                url: `${domainURL}/til_board/${idx}`,
                data: {},
                success: function (response){
                    let title = response['tilTitle']
                    let content = response['tilContent']
                    let user = response['user']['nickname'];
                    let idx = response['id']
                    $("#modal-title").val(title);
                    $("#modal-content").val(content);
                    $("#modal-user").text(user);
                    $("#modal-save").attr("onclick", `update_til('${idx}');`);
                }
            });
        }

        function update_til(idx){
            let info = {
                tilTitle : $('input#modal-title').val(),
                tilContent : $('textarea#modal-content').val()
            }

            $.ajax({
                type: "PUT",
                url: `${domainURL}/til_board/${idx}`,
                contentType: "application/json",
                data: JSON.stringify(info),
                success: function (response){
                    alert("수정 완료!");
                    window.location.reload();
                }
            });
        }

        function delete_til(idx){
            $.ajax({
                type: "DELETE",
                url: `${domainURL}/til_board/${idx}`,
                success: function (response){
                    alert("삭제 완료!");
                    window.location.reload();
                }
            });
        }

        function update_view(idx){
            $.ajax({
                type: "PUT",
                url: `${domainURL}/til_board/${idx}/view`,
                data: {},
                success: function (response){
                    alert("공개/비공개 변경 완료!");
                    window.location.reload();
                }
            });
        }

    </script>

    <style>
        body {
            background-color: #eeeeee;
        }

        .h7 {
            font-size: 0.8rem;
        }

        .gedf-wrapper {
            margin-top: 0.97rem;
        }

        @media (min-width: 992px) {
            .gedf-main {
                padding-left: 4rem;
                padding-right: 4rem;
            }

            .gedf-card {
                margin-bottom: 2.77rem;
            }
        }

        .navbar-brand {
            margin-left: 50px;
        }

        .nav-link {

            margin-left: 100px;
        }

        /* Reset Bootstrap */
        .dropdown-toggle::after {
            content: none;
            display: none;
        }
    </style>
</head>
<body>

<!-- navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="./home.html">TIL.D.P</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div id="navbar-nav" class="navbar-nav">
                <a class="nav-link " href="./til_board.html">Write TIL</a>
                <a class="nav-link" href="./mytil_page.html">My TIL</a>
                <a class="nav-link" href="https://github.com/">Github</a>
                <a class="nav-link" href="./my_page.html">myPage</a>
                <a class="nav-link" onclick="sign_out()">logout</a>
                <a class="nav-link" onclick="goback()">Back</a>
            </div>
        </div>
    </div>
    <form class="form-inline">
        <div class="input-group">
            <input type="text" class="form-control" aria-label="Recipient's username" aria-describedby="button-addon2">
            <div class="input-group-append">
                <button class="btn btn-outline-primary" type="button" id="button-addon2">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </form>
</nav>



<div class="container-fluid gedf-wrapper">
    <!-- container -->
    <div class="row">
        <!-- User Profile -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="h5">@<label class ="text-label user_id_append"></label></div>
                    <div class="h7 text-muted">Nickname : <label class ="text-label user_nickname_append"></label></div>
                    <div class="h7"><label class ="text-label user_profile_info_append"></label></div>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <div class="h6 text-muted">Followers</div>
                        <div class="h5">10000</div>
                    </li>
                    <li class="list-group-item">
                        <div class="h6 text-muted">Following</div>
                        <div class="h5">20000</div>
                    </li>
                    <li class="list-group-item github_id_tag">Github : <label class ="text-label github_id_append"></label></li>
                </ul>
            </div>
        </div>

        <!-- Post List -->
        <div class="col-md-6 gedf-main" id="post-list">

        </div>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Edit Form</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form name="form" id="form" role="form" method="post">
                            <div class="mb-3">
                                <label for="modal-title">제목</label>
                                <input type="text" class="form-control" name="title" id="modal-title"
                                       placeholder="제목을 입력해 주세요" value="">
                            </div>
                            <div class="mb-3">
                                <label for="modal-user">작성자</label>
                                <p id="modal-user"></p>
                            </div>
                            <div class="mb-3">
                                <label for="modal-content">내용</label>
                                <textarea class="form-control" rows="5" name="content" id="modal-content"
                                          placeholder="내용을 입력해 주세요"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <input type="submit" class="btn btn-primary" id="modal-save" onclick=""
                               value="Save changes"></button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal END -->

        <!-- Card List -->
        <div class="col-md-3">
            <!-- Card -->
            <div class="card gedf-card">
                <div class="card-body">
                    <h5 class="card-title">Card title</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Card subtitle</h6>
                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                        card's content.</p>
                    <a href="#" class="card-link">Card link</a>
                    <a href="#" class="card-link">Another link</a>
                </div>
            </div>
            <!-- Card -->
            <div class="card gedf-card">
                <div class="card-body">
                    <h5 class="card-title">Card title</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Card subtitle</h6>
                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                        card's content.</p>
                    <a href="#" class="card-link">Card link</a>
                    <a href="#" class="card-link">Another link</a>
                </div>
            </div>
        </div>

    </div>
</div>
<!-- toast -->
<article class="message is-danger" id="toast">
    <div class="message-header">
        <strong class="me-auto" id="til_title"></strong>
        <button class="delete" aria-label="delete" onclick="toast_close()"></button>
    </div>
    <div class="message-body" id="til_content">
    </div>
</article>
<!-- toast end -->
</body>