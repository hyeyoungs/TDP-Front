<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="back.js" rel="script"></script>

    <!-- Bulma -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">

    <script>
        let roomId;
        let roomName;
        let username;
        let id;
        let stomp;
        $(document).ready(function () {
            id = window.location.search.split("=")[1]
            read_room();
            user_info=read_user();
            username=user_info['username']

            var sockJs = new SockJS(`${domainURL}/stomp/chat`);
            //1. SockJS를 내부에 들고있는 stomp를 내어줌


            var stomp = Stomp.over(sockJs);
            //2. connection이 맺어지면 실행
            stomp.connect({}, function () {
                //4. subscribe(path, callback)으로 메세지를 받을 수 있음
                stomp.subscribe(`/sub/chat/room/` + roomId, function (chat) {
                    console.log(roomId)
                    let content = JSON.parse(chat.body);
                    let writer = content.writer;
                    let str = '';
                    if (writer === username) {
                        str = "<div class='col-6'>";
                        str += "<div class='alert alert-secondary'>";
                        str += "<b>" + writer + " : " + content.message + "</b>";
                        str += "</div></div>";
                    }
                    else {
                        str = "<div class='col-6'>";
                        str += "<div class='alert alert-warning'>";
                        str += "<b>" + writer + " : " + content.message + "</b>";
                        str += "</div></div>";
                    }
                    $("#msgArea").append(str);
                });
                //3. send(path, header, message)로 메세지를 보낼 수 있음
                stomp.send("/pub/chat/enter", {}, JSON.stringify({
                    roomId: roomId, writer: username, message:"enter", userCount:0}))
            });

            $("#button-send").on("click", function (e) {
                let msg = document.getElementById("msg");
                stomp.send('/pub/chat/message', {}, JSON.stringify({
                    roomId: roomId,
                    message: msg.value,
                    writer: username,
                    userCount: 0

                }));
                msg.value = '';
            });
        });

        function disconnect() {
            stomp.send('/pub/chat/exit', {}, JSON.stringify({roomId: roomId, writer: username, message:"exit"}))
            if (stomp !== null) {
                stomp.disconnect();
            }
        }
        window.onbeforeunload = function(){
            disconnect();
        }

        $.ajaxPrefilter(function( options, originalOptions, jqXHR ) {
            login_check(options, originalOptions, jqXHR);
        });

        function read_room() {
            $.ajax({
                type: "GET",
                url: `${domainURL}/room/${id}`,
                data: {},
                success: function (response) {
                    roomId = response['roomId'];
                    roomName = response['name'];
                    $('#room-name').text(roomName);
                }
            });
        }
        function enterkey() {
            if (window.event.keyCode == 13) {
                let msg = document.getElementById("msg");
                stomp.send('/pub/chat/message', {}, JSON.stringify({
                    roomId: roomId,
                    message: msg.value,
                    writer: username,
                    userCount: 0

                }));
                msg.value = '';
            }
        }
    </script>
    <style>
        .navbar-brand {
            margin-left: 50px;
        }

        .nav-link {

            margin-left: 100px;
        }

        .center {
            border-radius: 20%;
            background-color: rgb(255,242,233);
            width: 800px;
            height: 800px;
            position: absolute;
            left: 15%; //parent인 document기준으로 50% 이동
            margin-left: -120px;
            top: 20%; //parent인 documnet기준으로 50% 이동
            margin-top: -120px;
        }
        .chat-room {
            display:inline-block;
            width: 120%;
            margin: 0 auto;
            text-align: center;
            padding-left: 210px;


        }
    </style>
</head>


<body>
<!-- navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="./home.html">TIL.D.P</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div id="navbar-nav" class="navbar-nav">
                <a class="nav-link " href="./til_board.html">Write TIL</a>
                <a class="nav-link" href="./mytil_page.html">My TIL</a>
                <a class="nav-link" href="https://github.com/">Github</a>
                <a class="nav-link" href="./my_page.html">myPage</a>
                <a class="nav-link" onclick="sign_out()">logout</a>
                <a class="nav-link" onclick="goback()">Back</a>
            </div>
        </div>
    </div>
</nav>


    <div class="center">
        <div class="chat-room">
            <div class="col-6" style="margin-top: 20px; margin-bottom: 20px">
                <h1 id="room"><strong>Room : </strong><span id="room-name" style="color: #ff6863">name</span></h1>
            </div>
            <div>
                <div id="msgArea" class="col"></div>
                <div class="col-6">
                    <div class="input-group mb-3">
                        <input type="text" id="msg" class="form-control">
                        <div class="input-group-append">
                            <button class="btn btn-outline-danger" type="button" id="button-send" onkeyup="enterkey()">전송</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6"></div>
        </div>
    </div>

    <!-- toast -->
    <div aria-live="polite" aria-atomic="true" style="position: relative; min-height: 200px;">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="1000000"
             style="position: absolute; top: 0; right: 0;">
            <div class="toast-header">
                <i class="bi bi-x-lg"></i>
                <strong class="me-auto" id="til_title">${title}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"
                        onclick="toast_close()"></button>
            </div>
            <div class="toast-body" id="til_content">
                ${content}
            </div>
        </div>
    </div>
    <!-- toast end -->
</body>

</html>
